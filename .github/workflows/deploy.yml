name: Deploy to Cloud.ru

on:
  push:
    branches:
      - master
    paths:
      - "apps/**"
      - "packages/**"
      - "ecosystem.config.js"
      - ".github/workflows/deploy.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            export PATH="$HOME/.local/bin:$HOME/.bun/bin:$PATH"
            
            # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            if [ -d ~/profitableweb/.git ]; then
              echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
              cd ~/profitableweb
              git fetch origin
              git reset --hard origin/master
            else
              echo "üì¶ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
              rm -rf ~/profitableweb
              git clone https://gitverse.ru/profitableweb.ru/pw-monorepo.git ~/profitableweb
              cd ~/profitableweb
            fi

            # API: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            cd apps/api
            uv sync

            # Web: —Å–±–æ—Ä–∫–∞
            cd ../web
            bun install
            [ -f vitest.config.ts ] && mv vitest.config.ts vitest.config.ts.bak
            bun run build

            # Admin: —Å–±–æ—Ä–∫–∞
            cd ../admin
            bun install
            bun run build

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
            cd ~/profitableweb
            pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js

            echo "‚úÖ Deploy completed!"

      - name: Verify deployment
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞..."
          sleep 5
          curl -f http://${{ secrets.SSH_HOST }}/api/health || echo "‚ö†Ô∏è Health check failed, but deploy might still be running"
