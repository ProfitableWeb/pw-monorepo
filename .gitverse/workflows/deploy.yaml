name: Deploy to Cloud.ru (GitVerse)

on:
  push:
    branches:
      - master
    paths:
      - "apps/**"
      - "packages/**"
      - "ecosystem.config.js"
      - ".gitverse/workflows/deploy.yaml"
      - "infra/nginx/**"
      - "infra/scripts/**"
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY || variables.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST || variables.SSH_HOST }} >> ~/.ssh/known_hosts
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY || variables.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST || variables.SSH_HOST }}

      - name: Deploy to VM
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -p ${SSH_PORT:-22} \
              ${SSH_USER}@${SSH_HOST} << 'EOF'
            set -e
            export PATH="$HOME/.local/bin:$HOME/.bun/bin:$PATH"
            
            # ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
            if [ -d ~/profitableweb/.git ]; then
              echo "ðŸ“¥ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
              cd ~/profitableweb
              git fetch origin
              git reset --hard origin/master
            else
              echo "ðŸ“¦ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
              rm -rf ~/profitableweb
              git clone https://gitverse.ru/profitableweb.ru/pw-monorepo.git ~/profitableweb
              cd ~/profitableweb
            fi

            # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° JS-Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¸Ð· ÐºÐ¾Ñ€Ð½Ñ Ð¼Ð¾Ð½Ð¾Ñ€ÐµÐ¿Ð¾ (ÐµÐ´Ð¸Ð½Ñ‹Ð¹ lockfile)
            bun install

            # API: ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
            cd apps/api
            uv sync

            # Web: ÑÐ±Ð¾Ñ€ÐºÐ°
            cd ../web
            [ -f vitest.config.ts ] && mv vitest.config.ts vitest.config.ts.bak
            bun run build

            # Admin: ÑÐ±Ð¾Ñ€ÐºÐ°
            cd ../admin
            bun run build

            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
            cd ~/profitableweb
            pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js

            echo "âœ… Deploy completed!"
          EOF
        env:
          SSH_USER: ${{ secrets.SSH_USER || variables.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST || variables.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT || variables.SSH_PORT }}

      - name: Verify deployment
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ°..."
          sleep 5
          curl -f http://${{ secrets.SSH_HOST || variables.SSH_HOST }}/api/health || echo "âš ï¸ Health check failed, but deploy might still be running"
