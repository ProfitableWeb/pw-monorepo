# PW-026: Обновление монорепо — React 19 + Next.js 16

## Информация о задаче

- **ID**: PW-026
- **Статус**: Done
- **Создано**: 2026-02-14
- **Приоритет**: Critical
- **Компонент**: Web, Admin, CI/CD, Infra
- **Теги**: #react19 #nextjs16 #dnd-kit #ci #nginx #pm2

## Постановка задачи

CI/CD deploy pipeline падал из-за конфликта `@types/react`: admin использовал React 18 (`@types/react@18`), web — React
19 (`@types/react@19`). Bun workspaces hoisting приводил к тому, что `tsc --noEmit` на VM видел обе версии и выдавал ~50
ошибок типов.

Временный воркэраунд (`ignoreBuildErrors: true`) не решал проблему, а лишь скрывал её.

## Решение: 5 коммитов

### Фаза A: Admin React 18 -> 19 + замена react-dnd

- `apps/admin/package.json`: react 18.3.1 -> 19.1.1, @types/react 18 -> 19
- Удалены: `react-dnd`, `react-dnd-html5-backend`, `react-popper`, `react-slick`, `react-responsive-masonry`
- Добавлены: `@dnd-kit/core`, `@dnd-kit/sortable`, `@dnd-kit/utilities`
- `categories-section.tsx`: полная переработка DnD с сохранением логики 3 зон (верх/центр/низ)

### Фаза B: Устранение конфликта @types/react

- `next.config.js`: `ignoreBuildErrors: true` -> `false`
- `@types/react`: снят жёсткий пин `19.0.8` -> `^19.0.8`
- `tsc --noEmit` проходит без ошибок

### Фаза C: Web Next.js 15.5.9 -> 16.1.6

- `next`: 15.5.9 -> ^16.0.0, `react`: ^19.1.1 -> ^19.2.0
- `sassOptions`: `includePaths` -> `loadPaths` (sass-loader v16), абсолютные пути в `additionalData`
- `eslint-config-next` -> `@next/eslint-plugin-next` + `eslint.config.mjs` (flat config)
- `build`: `next build --webpack` (Turbopack не поддерживает SCSS @import на Windows)
- Удалён блок `eslint` из next.config.js (удалён в Next 16)
- `vitest.config.ts` исключён из tsconfig (конфликт версий vite)

### Фаза D: PM2 + nginx + CI

- `ecosystem.config.js`: admin `"run start"` -> `"run preview"` (vite preview)
- `vite.config.ts`: `base: '/admin/'`, `preview.port: 3001`
- `nginx`: удалён блок `/_next/static/` для admin, добавлен `/admin/assets/` с кешированием
- CI: удалён хак `vitest.config.ts.bak`

### Фаза E: Lint-staged + документация

- `.lintstagedrc.js`: добавлены правила для `apps/admin/**/*.{ts,tsx}`
- `apps/admin/package.json`: добавлен скрипт `type-check`
- Документация задачи

## Известные ограничения

- **Turbopack + SCSS**: на Windows Turbopack не поддерживает `@import` с относительными путями; используем `--webpack`
  для билда
- **SCSS @import deprecation**: 58 SCSS файлов с 156 `@import` — миграция на `@use` отложена в отдельную задачу
- **Admin type errors**: ~100 pre-existing ошибок TypeScript (unused imports, possibly undefined), не блокируют Vite
  build
- **React.forwardRef**: 9 файлов в admin — deprecated в React 19, но работает; миграция отложена

## Версии после обновления

| Пакет             | Web    | Admin  |
| ----------------- | ------ | ------ |
| React             | 19.2.x | 19.1.x |
| Next.js           | 16.1.x | —      |
| Vite              | —      | 6.3.5  |
| TypeScript        | 5.9.x  | 5.9.x  |
| @dnd-kit/core     | —      | 6.3.x  |
| @dnd-kit/sortable | —      | 10.0.x |
