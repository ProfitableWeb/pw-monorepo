stages:
  - deploy

deploy:
  stage: deploy
  only:
    - master
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
    - chmod 600 ~/.ssh/deploy_key
    - ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
  script:
    - |
      ssh -i ~/.ssh/deploy_key \
          -p ${SSH_PORT:-22} \
          ${SSH_USER}@${SSH_HOST} << 'EOF'
        set -e
        
        # Переход в директорию проекта
        cd ~/profitableweb || git clone $CI_REPOSITORY_URL ~/profitableweb
        cd ~/profitableweb
        
        # Обновление кода
        git pull origin master
        
        # API: установка зависимостей
        cd apps/api
        uv sync
        
        # Web: сборка
        cd ../web
        bun install
        bun run build
        
        # Admin: сборка
        cd ../admin
        bun install
        bun run build
        
        # Перезапуск всех сервисов
        cd ~/profitableweb
        pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js
        
        echo "✅ Deploy completed!"
      EOF
